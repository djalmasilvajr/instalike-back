"use strict";var _excluded=["firstAssistantMessage"];function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _regeneratorRuntime(){_regeneratorRuntime=function(){return a};var u,a={},t=Object.prototype,c=t.hasOwnProperty,l=Object.defineProperty||function(t,e,r){t[e]=r.value},e="function"==typeof Symbol?Symbol:{},o=e.iterator||"@@iterator",r=e.asyncIterator||"@@asyncIterator",n=e.toStringTag||"@@toStringTag";function i(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{i({},"")}catch(u){i=function(t,e,r){return t[e]=r}}function s(t,e,r,o){var n,i,a,s,e=e&&e.prototype instanceof m?e:m,e=Object.create(e.prototype),o=new T(o||[]);return l(e,"_invoke",{value:(n=t,i=r,a=o,s=p,function(t,e){if(s===d)throw new Error("Generator is already running");if(s===g){if("throw"===t)throw e;return{value:u,done:!0}}for(a.method=t,a.arg=e;;){var r=a.delegate;if(r){r=function t(e,r){var o=r.method,n=e.iterator[o];if(n===u)return r.delegate=null,"throw"===o&&e.iterator.return&&(r.method="return",r.arg=u,t(e,r),"throw"===r.method)||"return"!==o&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+o+"' method")),f;o=h(n,e.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,f;n=o.arg;return n?n.done?(r[e.resultName]=n.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=u),r.delegate=null,f):n:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,f)}(r,a);if(r){if(r===f)continue;return r}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if(s===p)throw s=g,a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);s=d;r=h(n,i,a);if("normal"===r.type){if(s=a.done?g:y,r.arg===f)continue;return{value:r.arg,done:a.done}}"throw"===r.type&&(s=g,a.method="throw",a.arg=r.arg)}})}),e}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}a.wrap=s;var p="suspendedStart",y="suspendedYield",d="executing",g="completed",f={};function m(){}function v(){}function b(){}var e={},_=(i(e,o,function(){return this}),Object.getPrototypeOf),_=_&&_(_(A([]))),w=(_&&_!==t&&c.call(_,o)&&(e=_),b.prototype=m.prototype=Object.create(e));function C(t){["next","throw","return"].forEach(function(e){i(t,e,function(t){return this._invoke(e,t)})})}function S(a,s){var e;l(this,"_invoke",{value:function(r,o){function t(){return new s(function(t,e){!function e(t,r,o,n){var i,t=h(a[t],a,r);if("throw"!==t.type)return(r=(i=t.arg).value)&&"object"==_typeof(r)&&c.call(r,"__await")?s.resolve(r.__await).then(function(t){e("next",t,o,n)},function(t){e("throw",t,o,n)}):s.resolve(r).then(function(t){i.value=t,o(i)},function(t){return e("throw",t,o,n)});n(t.arg)}(r,o,t,e)})}return e=e?e.then(t,t):t()}})}function k(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function $(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function T(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(k,this),this.reset(!0)}function A(e){if(e||""===e){var r,t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length))return r=-1,(t=function t(){for(;++r<e.length;)if(c.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=u,t.done=!0,t}).next=t}throw new TypeError(_typeof(e)+" is not iterable")}return l(w,"constructor",{value:v.prototype=b,configurable:!0}),l(b,"constructor",{value:v,configurable:!0}),v.displayName=i(b,n,"GeneratorFunction"),a.isGeneratorFunction=function(t){t="function"==typeof t&&t.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},a.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,i(t,n,"GeneratorFunction")),t.prototype=Object.create(w),t},a.awrap=function(t){return{__await:t}},C(S.prototype),i(S.prototype,r,function(){return this}),a.AsyncIterator=S,a.async=function(t,e,r,o,n){void 0===n&&(n=Promise);var i=new S(s(t,e,r,o),n);return a.isGeneratorFunction(e)?i:i.next().then(function(t){return t.done?t.value:i.next()})},C(w),i(w,n,"Generator"),i(w,o,function(){return this}),i(w,"toString",function(){return"[object Generator]"}),a.keys=function(t){var e,r=Object(t),o=[];for(e in r)o.push(e);return o.reverse(),function t(){for(;o.length;){var e=o.pop();if(e in r)return t.value=e,t.done=!1,t}return t.done=!0,t}},a.values=A,T.prototype={constructor:T,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=u,this.done=!1,this.delegate=null,this.method="next",this.arg=u,this.tryEntries.forEach($),!t)for(var e in this)"t"===e.charAt(0)&&c.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=u)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var o=this;function t(t,e){return i.type="throw",i.arg=r,o.next=t,e&&(o.method="next",o.arg=u),!!e}for(var e=this.tryEntries.length-1;0<=e;--e){var n=this.tryEntries[e],i=n.completion;if("root"===n.tryLoc)return t("end");if(n.tryLoc<=this.prev){var a=c.call(n,"catchLoc"),s=c.call(n,"finallyLoc");if(a&&s){if(this.prev<n.catchLoc)return t(n.catchLoc,!0);if(this.prev<n.finallyLoc)return t(n.finallyLoc)}else if(a){if(this.prev<n.catchLoc)return t(n.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<n.finallyLoc)return t(n.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;0<=r;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&c.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var n=o;break}}var i=(n=n&&("break"===t||"continue"===t)&&n.tryLoc<=e&&e<=n.finallyLoc?null:n)?n.completion:{};return i.type=t,i.arg=e,n?(this.method="next",this.next=n.finallyLoc,f):this.complete(i)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),f},finish:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),$(r),f}},catch:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var r,o,n=this.tryEntries[e];if(n.tryLoc===t)return"throw"===(r=n.completion).type&&(o=r.arg,$(n)),o}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:A(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=u),f}},a}function asyncGeneratorStep(t,e,r,o,n,i,a){try{var s=t[i](a),u=s.value}catch(t){return void r(t)}s.done?e(u):Promise.resolve(u).then(o,n)}function _asyncToGenerator(s){return function(){var t=this,a=arguments;return new Promise(function(e,r){var o=s.apply(t,a);function n(t){asyncGeneratorStep(o,e,r,n,i,"next",t)}function i(t){asyncGeneratorStep(o,e,r,n,i,"throw",t)}n(void 0)})}}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){var r;if(t)return"string"==typeof t?_arrayLikeToArray(t,e):"Map"===(r="Object"===(r=Object.prototype.toString.call(t).slice(8,-1))&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,o=new Array(e);r<e;r++)o[r]=t[r];return o}function _objectWithoutProperties(t,e){if(null==t)return{};var r,o=_objectWithoutPropertiesLoose(t,e);if(Object.getOwnPropertySymbols)for(var n=Object.getOwnPropertySymbols(t),i=0;i<n.length;i++)r=n[i],0<=e.indexOf(r)||Object.prototype.propertyIsEnumerable.call(t,r)&&(o[r]=t[r]);return o}function _objectWithoutPropertiesLoose(t,e){if(null==t)return{};for(var r,o={},n=Object.keys(t),i=0;i<n.length;i++)r=n[i],0<=e.indexOf(r)||(o[r]=t[r]);return o}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,_toPropertyKey(o.key),o)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){t=_toPrimitive(t,"string");return"symbol"==_typeof(t)?t:String(t)}function _toPrimitive(t,e){if("object"!=_typeof(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0===r)return("string"===e?String:Number)(t);r=r.call(t,e||"default");if("object"!=_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}var ChatbotImmersion=function(){function o(){var t,e=this,r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{codeAreaDefaultCopyMessage:codeAreaDefaultCopyMessage,codeAreaCopiedMessage:codeAreaCopiedMessage,firstAssistantMessage:firstAssistantMessage,upvoteIconAltMessage:upvoteIconAltMessage,downvoteIconAltMessage:downvoteIconAltMessage,copyIconAltMessage:copyIconAltMessage,upvoteIconTooltipMessage:upvoteIconTooltipMessage,downvoteIconTooltipMessage:downvoteIconTooltipMessage,copyIconTooltipMessage:copyIconTooltipMessage};return _classCallCheck(e,o),e.$video=document.querySelector("#video-container-data"),e.$chatbot=document.querySelector("#chatbot"),e.$chatbotBody=document.querySelector(".chatbot-body"),e.$chatInput=document.querySelector(".chatbot-footer__send-area-content"),e.$openChatbotButton=document.querySelector(".chatbot-cta"),e.$closeChatbotButton=document.querySelector(".chatbot-header__close"),e.$sendMessageButton=document.querySelector(".chatbot-footer__send-area-btn"),e.$suggestedMessagesFromChatbot=document.querySelectorAll(".chatbot-footer__questions-item"),e.$suggestedMessagesFromChatbotContainer=document.querySelector(".suggestion-main-container"),e.$cleanConversationButton=document.querySelector(".chatbot-footer__actions-clean-conversation"),e.$immersionClassBody=document.querySelector(".class-page"),e.luriStorage=new LuriStorage,e.luriClient=new LuriClient,e.hasSendFirstInteraction=!1,t=r.firstAssistantMessage,r=_objectWithoutProperties(r,_excluded),e.luriView=new LuriView(e.luriClient,r),e.$dataset=(null!=e.$video?e.$video:document.querySelector(".class-page__video")).dataset,e.immersionClassId=e.$immersionClassBody.dataset.immersionClassId,e.immersionClassTitle=e.$dataset.immersionClassTitle,e.immersionName=e.$dataset.immersionName,e.immersionCategory=e.$dataset.immersionCategoryName,e.immersionWorkload=e.$dataset.immersionWorkload,e.isAssistantReplying=!1,void(e.firstAssistantMessage=t)}var e,t;return _createClass(o,[{key:"debounce",value:function(t,e){var r;return function(){clearTimeout(r),r=setTimeout(t,e)}}},{key:"setupListeners",value:function(){var r=this;document.addEventListener("ImmersionClassNearCompletionEvent",function(){var t;r.isChatbotOpen()||(t=r.createSuggestTaskTooltip(),r.$openChatbotButton.prepend(t))}),this.$cleanConversationButton.addEventListener("click",function(){2<=r.$chatbotBody.querySelectorAll(".chatbot-msg").length&&!r.isAssistantReplying&&(r.$chatbotBody.replaceChildren(),r.luriStorage.removeKey(r._getStorageKey()),r.showSuggestedMessagesFromChatbot())}),this.$sendMessageButton.addEventListener("click",function(){r.sendMessageToChatbot()}),this.$chatInput.addEventListener("keydown",function(t){t.stopPropagation();var e=t.key;r.$chatInput.style.height=0,r.$chatInput.style.height=r.$chatInput.scrollHeight+"px","Enter"!==e||t.shiftKey||(t.preventDefault(),r.isAssistantReplying)||r.sendMessageToChatbot()}),this.$openChatbotButton.addEventListener("click",function(){var t;r.openChatbot(),r.removeSuggestTaskTooltip(),r.$chatInput.focus(),0<r.$chatbotBody.children.length?r.$chatbotBody.scrollTop=r.$chatbotBody.scrollHeight:(t=r.luriStorage.getKey(r._getStorageKey()))&&r.luriClient.getMessagesFromChat(t).then(function(t){var e;r.hideSuggestedMessagesFromChatbot(),(e=r.$chatbotBody).append.apply(e,_toConsumableArray(r.luriView.createMessagesNodesFrom(t))),r.$chatbotBody.scrollTop=r.$chatbotBody.scrollHeight})}),this.$closeChatbotButton.addEventListener("click",function(){r.closeChatbot()}),this.$suggestedMessagesFromChatbot.forEach(function(t){t.addEventListener("click",function(t){t=t.target.textContent;r.isAssistantReplying||r.replyWithAssistantMessageTo(t)})})}},{key:"openChatbot",value:function(){this.isChatbotOpen()||(this.$immersionClassBody.classList.add("chatbot-open"),this.$immersionClassBody.style.marginRight="600px",this.$chatbot.style.width="600px")}},{key:"isChatbotOpen",value:function(){return this.$immersionClassBody.classList.contains("chatbot-open")}},{key:"closeChatbot",value:function(){this.isChatbotOpen()&&(this.$immersionClassBody.classList.remove("chatbot-open"),this.$chatbot.style.width=null,this.$immersionClassBody.style.marginRight="auto")}},{key:"sendMessageToChatbot",value:function(){var t=this.$chatInput.value.trim();t&&(this.$chatInput.value="",this.$chatInput.style.height="",this.replyWithAssistantMessageTo(t))}},{key:"getCurrentChatbotId",value:(t=_asyncToGenerator(_regeneratorRuntime().mark(function t(){var e;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(e=this.luriStorage.getKey(this._getStorageKey()))return t.abrupt("return",e);t.next=3;break;case 3:return t.next=5,this.luriClient.createChatbotForImmersion(this.immersionClassId);case 5:return e=t.sent,this.luriStorage.insertKey(this._getStorageKey(),e),t.abrupt("return",e);case 8:case"end":return t.stop()}},t,this)})),function(){return t.apply(this,arguments)})},{key:"getPromptKind",value:function(e){return Array.from(this.$suggestedMessagesFromChatbot).some(function(t){return t.textContent===e})?e:"Prompt personalizado pelo aluno"}},{key:"doAnalytics",value:function(t){if(!this.hasSendFirstInteraction){try{var e=window.dataLayerAlura||[],r=document.querySelector(".yt-player"),o=null!=r?r.id:null,n=$(".vjs-current-time-display"),i=null!=o&&window.YT&&window.YT.get(o)?(window.YT.get(o).getCurrentTime()/60).toFixed(2):null!=n?parseFloat(n.text().replace(":",".")):0;e.push({event:"started_interact_luri",name:this.immersionClassTitle,immersion:{name:this.immersionName,category:this.immersionCategory},workload:this.immersionWorkload,assisted_time:i,prompt:this.getPromptKind(t)})}catch(t){console.log(t)}this.hasSendFirstInteraction=!0}}},{key:"replyWithAssistantMessageTo",value:(e=_asyncToGenerator(_regeneratorRuntime().mark(function t(e){var r,o,n,i,a,s,u=this;return _regeneratorRuntime().wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=function(t){t.scroll({top:t.scrollHeight,behavior:"smooth"})},(o=function(t,e){t.appendChild(e),r(t)})(this.$chatbotBody,this.luriView.createUserMessageNode({text:e})),this.$chatInput.focus(),this.isAssistantReplying=!0,this.hideSuggestedMessagesFromChatbot(),this.hideCurrentAskForVote(),t.next=9,this.getCurrentChatbotId();case 9:return n=t.sent,i=this.luriView.createEmptyAssistantMessageNode(),o(this.$chatbotBody,i),this.doAnalytics(e),t.next=15,this.luriClient.sendMessageToChatbotStreaming(n,{message:e});case 15:return s=t.sent,t.next=18,this.luriView.fillAssistantMessageNodeWithTextChunks(i,s,function(){return r(u.$chatbotBody)});case 18:return a=t.sent,t.next=21,this.luriClient.getLastMessageIdFromChat(n);case 21:s=t.sent,this.luriView.fillAssistantMessageNodeWithMessageId(a,s),this.isAssistantReplying=!1;case 24:case"end":return t.stop()}},t,this)})),function(t){return e.apply(this,arguments)})},{key:"hideSuggestedMessagesFromChatbot",value:function(){this.$suggestedMessagesFromChatbotContainer.classList.add("suggestion-main-container--hidden")}},{key:"showSuggestedMessagesFromChatbot",value:function(){this.$suggestedMessagesFromChatbotContainer.classList.remove("suggestion-main-container--hidden")}},{key:"hideCurrentAskForVote",value:function(){var t;null!=(t=this.$chatbotBody.querySelector(".chatbot-ask-vote"))&&t.remove()}},{key:"createSuggestTaskTooltip",value:function(){var r=this,t=this.luriView.nodeFromString('\n            <div class="suggest-task-tooltip" >\n                <button class="suggest-task-tooltip__close-btn">X</button>\n                <div class="suggest-task-tooltip__text">\n                    <h4>Parabéns por assistir a aula! ✨ </h4>\n                    <p>Quer testar seus conhecimentos com um exercício ou questionário relacionado ao conteúdo abordado na aula?</p>\n                </div>\n                <div class="suggest-task-tooltip__btn-container">\n                    <button class="suggest-task-tooltip__suggest-task-btn" data-message-prompt="Sugira um exercício a partir da aula">Exercício</button>\n                    <button class="suggest-task-tooltip__suggest-task-btn" data-message-prompt="Sugira um questionário a partir da aula">Questionário</button>\n                </div>\n            </div>\n        ');return t.querySelectorAll(".suggest-task-tooltip__suggest-task-btn").forEach(function(e){e.addEventListener("click",function(){var t=e.dataset.messagePrompt;r.removeSuggestTaskTooltip(),r.openChatbot(),r.replyWithAssistantMessageTo(t)})}),t.querySelector(".suggest-task-tooltip__close-btn").addEventListener("click",function(t){t.stopPropagation(),r.removeSuggestTaskTooltip()}),t}},{key:"removeSuggestTaskTooltip",value:function(){var t;null!=(t=this.$chatbot.querySelector(".suggest-task-tooltip"))&&t.remove()}},{key:"_getStorageKey",value:function(){return"IMMERSIONCLASS-".concat(this.immersionClassId)}}]),o}();